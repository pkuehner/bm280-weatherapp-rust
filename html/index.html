<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: #333;
        }
        header {
            background-color: #0078d4;
            color: white;
            padding: 20px;
            text-align: center;
        }
        header h1 {
            margin: 0;
            font-size: 2.5em;
        }
        main {
            padding: 20px;
        }
        #timeDiv, #tempDiv, #humidityDiv {
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        #chartContainer {
            height: 50%;
        }
        #chartDiv {
            height: 800px;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }
        label {
            font-size: 1.5em;
            font-weight: bold;
            display: block;
            margin-bottom: 10px;
        }
        footer {
            background-color: #0078d4;
            color: white;
            text-align: center;
            padding: 10px;
            position: fixed;
            width: 100%;
            bottom: 0;
        }
    </style>
</head>
<body>
    <header>
        <h1>Passi's Temperatur Dashboard</h1>
    </header>
    <main>
        <div id="timeDiv"></div>
        <div id="tempDiv"></div>
        <div id="humidityDiv"></div>
        <hr>
        <div id="chartDiv">
            <label>Daily Overview</label>
            <canvas id="chartContainer" ></canvas>
        </div>
        <hr>
        <div id="averagesDiv" style="margin-top: 20px; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);">
            <label>Averages Visualization</label>
            <div style="margin: 20px 0;">
                <label for="aggregationType" style="font-size: 1.1em; margin-right: 10px;">Aggregation Type:</label>
                <select id="aggregationType" style="padding: 8px; font-size: 1em; border-radius: 4px; border: 1px solid #ccc;">
                    <option value="hourly">Hourly</option>
                    <option value="weekday">Weekday</option>
                    <option value="monthly">Monthly</option>
                </select>
            </div>
            <div style="margin: 20px 0;">
                <label for="startDate" style="font-size: 1.1em; margin-right: 10px;">Start Date:</label>
                <input type="date" id="startDate" style="padding: 8px; font-size: 1em; border-radius: 4px; border: 1px solid #ccc; margin-right: 20px;">
                <label for="endDate" style="font-size: 1.1em; margin-right: 10px;">End Date:</label>
                <input type="date" id="endDate" style="padding: 8px; font-size: 1em; border-radius: 4px; border: 1px solid #ccc;">
            </div>
            <button id="updateAverages" style="padding: 10px 20px; font-size: 1.1em; background-color: #0078d4; color: white; border: none; border-radius: 4px; cursor: pointer;">Update Averages</button>
            <div style="height: 500px; margin-top: 20px;">
                <canvas id="averagesChart"></canvas>
            </div>
        </div>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script>
        window.onload = function() {
            fetch('http://pi:8000/current')
                .then(response => response.json())
                .then(data => {
                    var tempDiv = document.getElementById('tempDiv');
                    var timeDiv = document.getElementById('timeDiv');
                    var humidityDiv = document.getElementById('humidityDiv');
                    timeDiv.innerHTML = 'Last Measured Time: ' + new Date(data.timestamp * 1000);
                    tempDiv.innerHTML = 'Temperature: ' + data.temperature + "° C";
                    humidityDiv.innerHTML = "Humidity: " + data.humidity + "%";
                })
                .catch(error => console.error('Error fetching data:', error));
            // Fetch data from your API (replace with your API endpoint)
            fetch('http://pi:8000/today')
                .then(response => response.json())
                .then(data => {
                    // Create an array of data points (assuming your API returns an array)
                    const dataPoints_humidity = data.map(item => ({ x: new Date(item.timestamp * 1000), y: item.humidity }));
                    const dataPoints_temperature = data.map(item => ({ x: new Date(item.timestamp * 1000), y: item.temperature }));
                    // Create the chart
                    const chart = new Chart('chartContainer', {
                        type: 'line', // Change to the desired chart type (e.g., 'bar', 'pie', etc.)
                        data: {
                            labels: dataPoints_humidity.map(point => point.x),
                            datasets: [{
                                label: 'Humidity',
                                data: dataPoints_humidity,
                                borderColor: 'blue',
                                fill: false,
                            },
                            {
                                label: 'Temperature',
                                data: dataPoints_temperature,
                                borderColor: 'red',
                                fill: false,
                            }],
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    type: 'time', // If your x-axis represents dates/times
                                    time: {
                                        unit: 'second', // Adjust as needed
                                    },
                                },
                                y: {
                                    beginAtZero: true,
                                },
                            },
                        },
                    });

                    // Render the chart
                    chart.update();
                })
                .catch(error => console.error('Error fetching data:', error));

            // Initialize averages chart
            let averagesChart = null;

            function fetchAverages() {
                const aggregationType = document.getElementById('aggregationType').value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                let url = `http://pi:8000/averages/${aggregationType}`;
                const params = [];
                
                if (startDate) {
                    const startTimestamp = Math.floor(new Date(startDate).getTime() / 1000);
                    params.push(`start=${startTimestamp}`);
                }
                
                if (endDate) {
                    const endTimestamp = Math.floor(new Date(endDate).getTime() / 1000);
                    params.push(`end=${endTimestamp}`);
                }
                
                if (params.length > 0) {
                    url += '?' + params.join('&');
                }
                
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        const labels = data.map(item => item.label);
                        const temperatures = data.map(item => item.avg_temperature);
                        const humidities = data.map(item => item.avg_humidity);
                        
                        if (averagesChart) {
                            averagesChart.destroy();
                        }
                        
                        const ctx = document.getElementById('averagesChart').getContext('2d');
                        averagesChart = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Average Temperature (°C)',
                                    data: temperatures,
                                    backgroundColor: 'rgba(255, 99, 132, 0.5)',
                                    borderColor: 'rgba(255, 99, 132, 1)',
                                    borderWidth: 1,
                                    yAxisID: 'y'
                                },
                                {
                                    label: 'Average Humidity (%)',
                                    data: humidities,
                                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                                    borderColor: 'rgba(54, 162, 235, 1)',
                                    borderWidth: 1,
                                    yAxisID: 'y1'
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    mode: 'index',
                                    intersect: false,
                                },
                                scales: {
                                    y: {
                                        type: 'linear',
                                        display: true,
                                        position: 'left',
                                        title: {
                                            display: true,
                                            text: 'Temperature (°C)'
                                        }
                                    },
                                    y1: {
                                        type: 'linear',
                                        display: true,
                                        position: 'right',
                                        title: {
                                            display: true,
                                            text: 'Humidity (%)'
                                        },
                                        grid: {
                                            drawOnChartArea: false,
                                        }
                                    }
                                }
                            }
                        });
                    })
                    .catch(error => console.error('Error fetching averages:', error));
            }

            // Load initial averages
            fetchAverages();

            // Add event listener to update button
            document.getElementById('updateAverages').addEventListener('click', fetchAverages);
        };
    </script>
</body>
</html>
